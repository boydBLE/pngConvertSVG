<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PNG to SVG Converter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }

    .container {
      display: flex;
      align-items: flex-start;
      gap: 20px;
    }

    .preview-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 300px;
    }

    .preview-container {
      width: 300px;
      height: 300px;
      overflow: auto;
      border: 1px solid #ccc;
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #preview, #svgWrapper {
      transform-origin: top left;
    }

    svg {
      width: 100%;
      height: 100%;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 300px;
    }

    button {
      margin-top: 5px;
    }

    .zoom-buttons {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h2>PNG to SVG Converter</h2>

  <input type="file" id="fileInput"><br><br>

  <div class="container">
    <!-- PNG Preview -->
    <div class="preview-box">
      <strong>PNG Preview</strong>
      <div class="preview-container">
        <img id="preview" alt="Preview will appear here" />
      </div>
      <div class="zoom-buttons">
        <button onclick="zoom('png', 1)">Zoom +</button>
        <button onclick="zoom('png', -1)">Zoom -</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <label>Threshold: <span id="thresholdValue">180</span></label>
      <input type="number" id="threshold" value="180" min="0" max="255">

      <label>Turd Size: <span id="turdValue">2</span></label>
      <input type="number" id="turdSize" value="2" min="0" max="50">

      <label>Alphamax: <span id="alphaValue">1.0</span></label>
      <input type="number" id="alphamax" value="1.0" min="0" max="1" step="0.1">

      <label>Stroke Width:</label>
      <input type="number" id="strokeWidth" value="1" min="0" step="0.1">

      <label>Stroke Color:</label>
      <input type="color" id="strokeColor" value="#000000">

      <label>Presets:</label>
      <select id="presetSelect">
        <option value="">None</option>
        <option value="minimal">Minimal</option>
        <option value="smooth">Smooth</option>
        <option value="detailed">Detailed</option>
      </select>

      <label><input type="checkbox" id="outlineOnly"> Outline Outer Only</label>

      <div>
        <button onclick="upload()">Convert</button>
        <button id="undoBtn" onclick="undo()" disabled>Undo</button>
        <button onclick="clearAll()">Clear</button>
        <button id="downloadBtn" onclick="downloadSVG()" style="display:none;">Download SVG</button>
      </div>
    </div>

    <!-- SVG Preview -->
    <div class="preview-box">
      <strong>SVG Preview</strong>
      <div class="preview-container">
        <div id="svgWrapper">
          <div id="svgPreview"></div>
        </div>
      </div>
      <div class="zoom-buttons">
        <button onclick="zoom('svg', 1)">Zoom +</button>
        <button onclick="zoom('svg', -1)">Zoom -</button>
      </div>
    </div>
  </div>

  <script>
    const preview = document.getElementById("preview");
    const svgPreview = document.getElementById("svgPreview");
    const svgWrapper = document.getElementById("svgWrapper");

    let pngZoom = 1;
    let svgZoom = 1;
    let historyStack = [];
    let currentSVG = '';

    document.getElementById("fileInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => preview.src = reader.result;
        reader.readAsDataURL(file);
      }
    });

    document.getElementById("presetSelect").addEventListener("change", e => {
      const preset = e.target.value;
      if (preset === "minimal") {
        setInputs(220, 10, 0.0);
      } else if (preset === "smooth") {
        setInputs(150, 2, 1.0);
      } else if (preset === "detailed") {
        setInputs(179, 1, 0.7);
      }
    });

    function setInputs(threshold, turdSize, alpha) {
      document.getElementById("threshold").value = threshold;
      document.getElementById("turdSize").value = turdSize;
      document.getElementById("alphamax").value = alpha;
      updateLabels();
    }

    function updateLabels() {
      document.getElementById("thresholdValue").textContent = document.getElementById("threshold").value;
      document.getElementById("turdValue").textContent = document.getElementById("turdSize").value;
      document.getElementById("alphaValue").textContent = document.getElementById("alphamax").value;
    }

    function zoom(target, dir) {
      if (target === 'png') {
        pngZoom += dir * 0.1;
        pngZoom = Math.max(0.1, pngZoom);
        preview.style.transform = `scale(${pngZoom})`;
      } else {
        svgZoom += dir * 0.1;
        svgZoom = Math.max(0.1, svgZoom);
        svgWrapper.style.transform = `scale(${svgZoom})`;
      }
    }

    async function upload() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Please upload a PNG file first.");

      const formData = new FormData();
      formData.append("image", file);
      formData.append("threshold", document.getElementById("threshold").value);
      formData.append("turdSize", document.getElementById("turdSize").value);
      formData.append("alphamax", document.getElementById("alphamax").value);
      formData.append("strokeWidth", document.getElementById("strokeWidth").value);
      formData.append("strokeColor", document.getElementById("strokeColor").value);
      formData.append("outlineOnly", document.getElementById("outlineOnly").checked);

      const res = await fetch("/api/vectorize", {
        method: "POST",
        body: formData
      });

      const svg = await res.text();
      if (currentSVG) historyStack.push(currentSVG);
      currentSVG = svg;
      svgPreview.innerHTML = svg;
      svgWrapper.style.transform = `scale(${svgZoom})`;
      document.getElementById("undoBtn").disabled = historyStack.length === 0;
      document.getElementById("downloadBtn").style.display = "inline-block";
    }

    function undo() {
      if (historyStack.length > 0) {
        currentSVG = historyStack.pop();
        svgPreview.innerHTML = currentSVG;
        svgWrapper.style.transform = `scale(${svgZoom})`;
        document.getElementById("undoBtn").disabled = historyStack.length === 0;
      }
    }

    function clearAll() {
      preview.src = "";
      svgPreview.innerHTML = "";
      historyStack = [];
      currentSVG = '';
      document.getElementById("undoBtn").disabled = true;
      document.getElementById("downloadBtn").style.display = "none";
    }

    function downloadSVG() {
      const blob = new Blob([currentSVG], { type: "image/svg+xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "converted-image.svg";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
