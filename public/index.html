
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Advanced PNG to SVG Vectorizer</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; padding: 20px; margin: 0; }
    h2 { text-align: center; }
    #layoutRow { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }
    .controls { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 300px; }
    .controls label { display: block; margin-top: 10px; }
    .controls input, .controls select { width: 100%; padding: 5px; }
    .previewBox { width: 400px; height: 400px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; overflow: auto; background: #fff; }
    #preview, #svgPreview svg { max-width: 100%; max-height: 100%; }
    button { margin-top: 10px; padding: 10px; width: 100%; font-size: 16px; }
  </style>
</head>
<body>
  <h2>PNG to SVG Converter</h2>
  <input type="file" id="fileInput"><br><br>
  <div id="layoutRow">
    <div class="previewBox"><img id="preview" /></div>
    <div class="controls">
      <label>Threshold:</label>
      <input type="number" id="threshold" min="0" max="255" value="180">
      <label>Turd Size:</label>
      <input type="number" id="turdSize" min="0" max="50" value="2">
      <label>Alpha Max:</label>
      <input type="number" id="alphamax" min="0" max="1" step="0.05" value="1.0">
      <label>Opt Tolerance:</label>
      <input type="number" id="optTolerance" min="0.01" max="1" step="0.01" value="0.2">
      <label>Outline Mode:</label>
      <select id="outlineMode">
        <option value="outline">Outer Contour Only</option>
        <option value="full">All Vector Shapes</option>
      </select>
      
      <label>Stroke Width:</label>
      <input type="number" id="strokeWidth" min="0" max="10" step="0.1" value="1">
      <label>Stroke Color:</label>
      <input type="color" id="strokeColor" value="#000000">
      <label>Brightness (%):</label>
      <input type="range" id="brightness" min="0" max="200" value="100">
      <label>Contrast (%):</label>
      <input type="range" id="contrast" min="0" max="200" value="100">
      <label>Filename:</label>
      <input type="text" id="filename" value="converted-image.svg">
      <label><input type="checkbox" id="darkModeToggle"> Dark Mode</label>
      <label><input type="checkbox" id="autoRefresh"> Auto Refresh</label>
      <button type="button" onclick="undo()">Undo</button>
      <button type="button" onclick="clearAll()">Clear</button>

      <button onclick="upload()">Convert</button>
      <button id="downloadBtn" style="display:none" onclick="downloadSVG()">Download SVG</button>
    </div>
    <div class="previewBox" id="svgPreview"></div>
  </div>
  <script>
    const preview = document.getElementById('preview');
    const svgPreview = document.getElementById('svgPreview');
    const downloadBtn = document.getElementById('downloadBtn');
    let currentSVG = '';

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => preview.src = reader.result;
        reader.readAsDataURL(file);
      }
    });

    async function upload() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert("Please upload a PNG image.");

      const formData = new FormData();
      formData.append("image", file);
      formData.append("threshold", document.getElementById("threshold").value);
      formData.append("turdSize", document.getElementById("turdSize").value);
      formData.append("alphamax", document.getElementById("alphamax").value);
      formData.append("optTolerance", document.getElementById("optTolerance").value);
      formData.append("outlineMode", document.getElementById("outlineMode").value);

      const res = await fetch("/api/vectorize", { method: "POST", body: formData });
      const svg = await res.text();
      svgPreview.innerHTML = svg;
      currentSVG = svg;
      downloadBtn.style.display = 'inline-block';
    }

    function downloadSVG() {
      const blob = new Blob([currentSVG], { type: "image/svg+xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "converted-image.svg";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  
    let previousState = null;

    function applyImageFilters() {
      const brightness = document.getElementById('brightness').value;
      const contrast = document.getElementById('contrast').value;
      preview.style.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
    }

    document.getElementById('brightness').addEventListener('input', applyImageFilters);
    document.getElementById('contrast').addEventListener('input', applyImageFilters);

    document.getElementById('darkModeToggle').addEventListener('change', (e) => {
      document.body.style.background = e.target.checked ? '#333' : '#f8f8f8';
      document.body.style.color = e.target.checked ? '#fff' : '#000';
    });

    function undo() {
      if (previousState) {
        Object.entries(previousState).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) el.value = value;
        });
        applyImageFilters();
      }
    }

    function clearAll() {
      document.getElementById('fileInput').value = '';
      preview.src = '';
      svgPreview.innerHTML = '';
      currentSVG = '';
      downloadBtn.style.display = 'none';
    }

    // Hook auto-refresh on all inputs
    document.querySelectorAll('.controls input, .controls select').forEach(el => {
      el.addEventListener('input', () => {
        if (document.getElementById('autoRefresh').checked) {
          upload();
        }
      });
    });

    // Save previous settings before upload
    function upload() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert("Please upload a PNG image.");
      previousState = {
        threshold: document.getElementById("threshold").value,
        turdSize: document.getElementById("turdSize").value,
        alphamax: document.getElementById("alphamax").value,
        optTolerance: document.getElementById("optTolerance").value,
        outlineMode: document.getElementById("outlineMode").value,
        strokeWidth: document.getElementById("strokeWidth").value,
        strokeColor: document.getElementById("strokeColor").value,
        brightness: document.getElementById("brightness").value,
        contrast: document.getElementById("contrast").value,
        filename: document.getElementById("filename").value,
      };

      const formData = new FormData();
      formData.append("image", file);
      formData.append("threshold", previousState.threshold);
      formData.append("turdSize", previousState.turdSize);
      formData.append("alphamax", previousState.alphamax);
      formData.append("optTolerance", previousState.optTolerance);
      formData.append("outlineMode", previousState.outlineMode);
      // Stroke options (can be added to SVG post-process later)
      // formData.append("strokeWidth", previousState.strokeWidth);
      // formData.append("strokeColor", previousState.strokeColor);

      fetch("/api/vectorize", { method: "POST", body: formData })
        .then(res => res.text())
        .then(svg => {
          svgPreview.innerHTML = svg;
          currentSVG = svg;
          downloadBtn.style.display = 'inline-block';
        });
    }

    function downloadSVG() {
      const filename = document.getElementById("filename").value || "converted-image.svg";
      const blob = new Blob([currentSVG], { type: "image/svg+xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

  </script>
</body>
</html>
