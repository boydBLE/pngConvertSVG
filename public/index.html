<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PNG to SVG Vectorizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 20px;
    }
    h2 {
      text-align: center;
    }
    .container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }
    .controls {
      flex: 1;
      max-width: 300px;
    }
    .preview-box {
      flex: 1;
      text-align: center;
    }
    .preview-box img,
    .preview-box svg {
      max-width: 100%;
      transform-origin: top left;
      border: 1px solid #ccc;
    }
    .zoom-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input[type="number"] {
      width: 100%;
    }
    button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>PNG to SVG Vectorizer</h2>
  <div class="container">
    <!-- PNG Preview -->
    <div class="preview-box">
      <h4>PNG Preview</h4>
      <div class="zoom-controls">
        <button onclick="zoomImage('in')">Zoom In</button>
        <button onclick="zoomImage('out')">Zoom Out</button>
      </div>
      <img id="preview" src="" alt="Preview">
    </div>

    <!-- Controls -->
    <div class="controls">
      <input type="file" id="fileInput">
      <label>Threshold: <input type="number" id="threshold" value="180" /></label>
      <label>Turd Size: <input type="number" id="turdSize" value="2" /></label>
      <label>Alpha Max: <input type="number" step="0.1" id="alphamax" value="1.0" /></label>
      <label>Opt Tolerance: <input type="number" step="0.1" id="optTolerance" value="0.2" /></label>
      <label>Turn Policy:
        <select id="turnPolicy">
          <option value="minority">Minority</option>
          <option value="majority">Majority</option>
          <option value="black">Black</option>
          <option value="white">White</option>
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </label>
      <label><input type="checkbox" id="invert"> Invert</label>
      <label><input type="checkbox" id="optCurve" checked> Optimize Curve</label>
      <label><input type="checkbox" id="outlineShapes"> Outline All Shapes</label>
      <label><input type="checkbox" id="outerOutlineOnly"> Outer Outline Only</label>
      <label>Preset:
        <select id="presetSelect">
          <option value="">None</option>
          <option value="minimal">Minimal</option>
          <option value="smooth">Smooth</option>
          <option value="detailed">Detailed</option>
        </select>
      </label>
      <button onclick="convert()">Convert</button>
      <button onclick="clearAll()">Clear</button>
      <button onclick="undo()">Undo</button>
      <button onclick="downloadSVG()">Download SVG</button>
    </div>

    <!-- SVG Preview -->
    <div class="preview-box">
      <h4>SVG Preview</h4>
      <div class="zoom-controls">
        <button onclick="zoomSVG('in')">Zoom In</button>
        <button onclick="zoomSVG('out')">Zoom Out</button>
      </div>
      <div id="svgContainer" style="overflow: auto;">
        <div id="result"></div>
      </div>
    </div>
  </div>

  <script>
    let svgZoom = 1;
    let imgZoom = 1;
    let svgHistory = [];
    let currentSVG = '';

    const preview = document.getElementById('preview');
    const resultDiv = document.getElementById('result');

    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => preview.src = reader.result;
      reader.readAsDataURL(file);
    });

    document.getElementById('presetSelect').addEventListener('change', (e) => {
      const preset = e.target.value;
      const set = (id, val) => document.getElementById(id).value = val;
      if (preset === 'minimal') {
        set('threshold', 220);
        set('turdSize', 10);
        set('alphamax', 0.0);
      } else if (preset === 'smooth') {
        set('threshold', 150);
        set('turdSize', 2);
        set('alphamax', 1.0);
      } else if (preset === 'detailed') {
        set('threshold', 179);
        set('turdSize', 1);
        set('alphamax', 0.7);
      }
    });

    async function convert() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert("Upload a PNG file first!");

      const formData = new FormData();
      formData.append("image", file);
      formData.append("threshold", document.getElementById('threshold').value);
      formData.append("turdSize", document.getElementById('turdSize').value);
      formData.append("alphamax", document.getElementById('alphamax').value);
      formData.append("optTolerance", document.getElementById('optTolerance').value);
      formData.append("turnPolicy", document.getElementById('turnPolicy').value);
      formData.append("invert", document.getElementById('invert').checked);
      formData.append("optCurve", document.getElementById('optCurve').checked);
      formData.append("outlineShapes", document.getElementById('outlineShapes').checked);
      formData.append("outerOutlineOnly", document.getElementById('outerOutlineOnly').checked);

      const res = await fetch('/api/vectorize', {
        method: 'POST',
        body: formData
      });

      const svg = await res.text();
      svgHistory.push(currentSVG);
      currentSVG = svg;
      resultDiv.innerHTML = svg;
      setSVGZoom(1);
    }

    function downloadSVG() {
      const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vectorized-image.svg';
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearAll() {
      preview.src = '';
      resultDiv.innerHTML = '';
      currentSVG = '';
      svgHistory = [];
    }

    function undo() {
      if (svgHistory.length > 0) {
        currentSVG = svgHistory.pop();
        resultDiv.innerHTML = currentSVG;
      }
    }

    function zoomImage(direction) {
      imgZoom += (direction === 'in' ? 0.1 : -0.1);
      imgZoom = Math.max(0.1, imgZoom);
      preview.style.transform = `scale(${imgZoom})`;
    }

    function zoomSVG(direction) {
      svgZoom += (direction === 'in' ? 0.1 : -0.1);
      svgZoom = Math.max(0.1, svgZoom);
      resultDiv.firstElementChild?.setAttribute('style', `transform: scale(${svgZoom}); transform-origin: top left;`);
    }

    function setSVGZoom(value) {
      svgZoom = value;
      resultDiv.firstElementChild?.setAttribute('style', `transform: scale(${svgZoom}); transform-origin: top left;`);
    }
  </script>
</body>
</html>
